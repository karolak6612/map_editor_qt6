**Task51: Data Serialization for `Map` (OTBM/XML/JSON - Method Implementation & Full `Item` Ser/Des)**
- Task: **Implement the actual functions for map data serialization and deserialization within the `Map` class (stubs from Task 51's original intent if that was just signatures). This involves full support for OTBM (OpenTibia Binary Map format) and potentially XML and JSON if these were target formats for the map itself or its components (spawns, houses etc. that are part of the map save), as implied by `wxwidgets::iomap_otbm.cpp` or `Task51.md`. This requires full `Item` serialization/deserialization.**
    - **Analyze Existing Serialization:** Review any map I/O or item serialization code in `Project_QT/src`.
    - **OTBM Support (Primary Focus):**
        -   **Saving to OTBM:** Fully implement `Map::saveToOTBM(NodeFileWriteHandle& handle)` (or similar, using an appropriate OTBM writer class/library like the original might have used, or a new one for Qt). This must serialize:
            -   Map header (version, dimensions, description).
            -   All `Tile` data: Iterate through all tiles on all floors. For each `Tile`, write its ground `Item`, all other `Item`s (including their full attributes from Task 48 â€“ quantity, actionID, text, etc.), and any associated `Creature`s or special tile flags. This relies heavily on `Item::serializeToOTBM(...)` methods.
            -   Map-level data like spawn points (`Spawn` objects from Task 19), houses (`House` objects from Task 66/73), waypoints (`Waypoint` objects from Task 63/71), towns, if these are stored as part of the OTBM map node structure.
        -   **Loading from OTBM:** Fully implement `Map::loadFromOTBM(...)`. This must parse the OTBM node structure, read map attributes, and correctly instantiate and populate all `Tile` objects with their `Item`s (using `ItemManager::createItem` then `Item::deserializeFromOTBM`) and other map entities.
    - **XML/JSON Support (if applicable for Map):**
        -   If `wxwidgets` supported saving/loading the *entire map* (not just sub-components like houses) to XML or JSON, implement `Map::saveToXML(...)`, `loadFromXML(...)`, etc., using `QXmlStreamWriter/Reader` or `QJsonDocument`. This would involve a similar deep serialization of all map contents. (This is distinct from individual components like houses having their own XML files if those are not part of the main map file stream).
    - **Item Serialization/Deserialization:** This task heavily depends on having robust `Item::serializeToOTBM(OTBMNode& itemNode)` and `Item::deserializeFromOTBM(const OTBMNode& itemNode)` (or similar stream-based methods). Ensure all `Item` attributes (from Task 13/48) are correctly written and read.
    - **Chunking Logic:** Consider and implement any chunking logic if the original OTBM read/write operations handled the map in `WxTileArea` nodes or similar tile-based chunks, especially for efficient partial loading/saving if that was a feature (though full map I/O is the baseline).
    - **Client Version Compatibility:** Handle any map data conversions or property interpretations based on the map's client version (read from the OTBM header) during loading/saving if the original system did this post-processing (e.g., some item IDs changing, attributes meaning different things). This interaction of version with `Item` properties is crucial.
    - **`Tile::modify()` state:** Ensure that loading a map or modifying it through deserialization correctly sets the modification status of `Tile`s and the `Map` itself, for dirty state tracking and interaction with the undo system (conceptual at this stage).
    - **Integration with `Map::save()` and `Map::open()`:** These higher-level methods in `Map` should now invoke the specific format save/load methods based on file extension or chosen format.
    - **`Task51.md` must provide exhaustive details on the OTBM node structure used by `wxwidgets` for map and item data, any specific libraries or classes used for OTBM I/O, how client versions affected map elements during I/O, and the exact XML/JSON schema if those were used for *full map* serialization.**
